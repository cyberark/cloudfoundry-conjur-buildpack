#!/bin/bash -ex

#
# Remote Integration Test Runner
#
# This runs only e2e features, which are those dependent on
# access to a remote PCF instance. Run this script from the `bin`
# directory with `summon ./test_e2e`, with
# proper summon credentials.
#

function finish {
  echo 'Removing environment'
  echo '-----'
  docker-compose down -v
}
trap finish EXIT

cd "$(dirname "$0")"

# Check for summon variables
: ${CF_API_ENDPOINT?"Need to set CF_API_ENDPOINT"}

# Set up the containers to run in their own namespace
COMPOSE_PROJECT_NAME="$(basename "$PWD")_$(openssl rand -hex 3)"
export COMPOSE_PROJECT_NAME

export BRANCH_NAME=${BRANCH_NAME:-$(git symbolic-ref --short HEAD)}

# Sets up conjur and retrieves credentials
. ./start_conjur

# Build the Java CI application
pushd apps/java
  ./bin/build
popd

# Build latest test images
docker-compose build

# Run tests against latest build of buildpack (including integration tests against remote foundation)
docker-compose run --rm \
   -w "/cyberark/cloudfoundry-conjur-buildpack/bin" \
   tester cucumber \
   --format pretty \
   --format junit \
   --out ./features/reports \
   --tags '@integration'
