#!/bin/bash -e
# bin/supply <build-dir> <cache-dir> <deps-dir> <index>

# The build directory for the app.
BUILD_DIR=$1

# To store assets needed during build (currently unused).
CACHE_DIR=$2

# App dependencies are stored in $DEPS_DIR/$INDEX_DIR.
DEPS_DIR=$3
INDEX_DIR=$4

BIN_DIR=$(cd $(dirname $0); pwd)
BUILDPACK_DIR=$(dirname $BIN_DIR)

echo "[cyberark-conjur-buildpack]: supplying"

if [ ! -f $BUILD_DIR/secrets.yml ]; then
  echo "No secrets.yml file found in $BUILD_DIR."
  exit 1
fi

if [[ false = $(echo $VCAP_SERVICES | jq 'has("cyberark-conjur")') ]]; then
  echo "No credentials for cyberark-conjur service found in VCAP_SERVICES."
  exit 1
fi

pushd ${DEPS_DIR}/${INDEX_DIR}
  # We add the lib/0001_retrieve-secrets.sh script to profile.d so that it will
  # be run automatically to retrieve secrets when the app starts.
  mkdir -p profile.d
  cp ${BUILDPACK_DIR}/lib/0001_retrieve-secrets.sh ./profile.d/0001_retrieve-secrets.sh
  sed "s/__BUILDPACK_INDEX__/$INDEX_DIR/g" ./profile.d/0001_retrieve-secrets.sh -i

  # conjur-env reads a secrets.yml file and uses it to retrieve secrets from
  # Conjur. We copy it to the dependency directory to make it accessible to the
  # /profile.d script. The /vendor subdirectory is just for convenience.
  mkdir -p vendor
  cp ${BUILDPACK_DIR}/vendor/conjur-env ./vendor/conjur-env
popd
